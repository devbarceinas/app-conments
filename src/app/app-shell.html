<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="login-component.html">

<dom-module id="app-shell">
  <template>
    <style>

      body{
          margin: 0;
          padding: 0;
      }

      .post__main_content{
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          background: linear-gradient(0deg, #ffff 80%, #004C99 80%);
      }
      .page{
          display: flex;
          align-self:flex-end;
          width:100%;
          height: 90vh;
          max-width: 900px;
      }
      .post__aside{
          padding: 24px 0 20px 8px;
          width: 240px;
          min-width: 240px;
          overflow-y:auto;
      }
      .page__content{
          display: flex;
          flex-direction: column;
          flex-grow:2;
          padding: 18px 8px;
          margin: 0 8px 0 18px;
          color:#fafafa;
          border-radius: 8px 8px 0 0;
          background: #EEF4F9;
      }
      .post__list{
          flex-grow: 2;
          overflow-y: auto;
          color:#333;
          /*background:aqua;*/
      }

      .container {
        display: flex;
        justify-content: center;
        padding-top: 50px;
      }

      .posts {
        display: none;
      }

      .container.sessionActive {
        display: none;
      }

      .container.sessionActive + .posts {
        display: block;
      }
      .current__user_name{
        font-size: 1.4em;
      }

      .post__style {
        color: #000;
      }

      .post__form {
        display: flex;
        justify-content: center;
        color: #000;
      }

      .space__items {
        height: 30px;
      }

      .button__output {
        background-color: #0093E2;
        color: #fff;
      }

      .logout {
        display: flex;
        justify-content: center;
      }

      .public__button {
        background-color: #004C99;
      }

      .form__container {
        padding: 20px;
      }

      .button__salir {
        background-color: #fafafa;
        margin-bottom: 10px;
      }

    </style>

    <iron-ajax
      id="postMessage"
      method="POST"
      url="https://posts-services.herokuapp.com/posts"
      handle-as="json"
      content-type="application/json"
      last-response="_handleResponse">
    </iron-ajax>

    <loader-spinner
      id="loader_spinner"
      paused>
    </loader-spinner>

    <div class="container" id="showPosts">
      <login-component
        id="login_component"
        on-check-user="_checkUser"
        on-login-submit="_loader"
        users="{{allUsers}}"
        class="border__alert">
      </loginComponent>
    </div>

    <div class="posts">
      <div class="post__main_content">
          <!-- PAG -->
          <div class="page">
              <aside class="post__aside">
                  <paper-button class="button__salir" on-click="_closeSession" raised>Salir</paper-button>
                  <user-list id="user_list" list="[[allUsers]]" on-user-selected="_userSelected"></user-list>
              </aside>
              <div class="page__content">
                  <template is="dom-if" if="[[showForm]]">
                    <div class="post__form">
                      <strong>
                        Escribe un nuevo post
                      </strong>
                    </div>
                    <div class="form__container">
                      <paper-input label="Titulo" id="title_form"></paper-input>
                      <paper-input label="¿Que estas pensando [[selectedUser.name]]?" id="posts_form"></paper-input>
                      <paper-button class="public__button" on-click="_save" raised>Publicar</paper-button>
                    </div>
                  </template>
                  <div class="space__items"></div>
                  <div class="post__style">
                    <strong class="current__user_name">
                      Post de [[selectedUser.name]]
                    </strong>
                  </div>
                  <div class="space__items"></div>
                  <div class="post__list">
                      <post-list id="post_list" list="[[selectedUser.posts]]"></post-list>
                  </div>
              </div>
          </div>
          <!-- END PAG -->
      </div>
    </div>

  </template>
  <script>
    (function appShell(customElements) {

      'use strict';

      class AppShell extends Polymer.Element {
        static get is() { return 'app-shell'; }
        static get properties() {
          return {
            sessionUser: {
              type: Object
            },
            slectedUser: {
              type: Object
            },
            allUsers: {
              type: Array
            },
            showForm:{
              type:Boolean,
              computed: '_showForm(sessionUser, selectedUser)'
            }
          };
        }

        _checkUser(event) {
          var that = this;
          let user = event.detail.data.filter(users => {
            let hasUser;
            try{
              hasUser = users.email === event.detail.useremail ? ( users.password === event.detail.password ? true : false ) : false;
            }catch(err){ hasUser = false; }
            return hasUser
          });
          if (user.length) {
            this.sessionUser = user[0];
            this.selectedUser = user[0];
            this.$.user_list.selectedId = user[0].email;
            this.$.showPosts.classList.toggle('sessionActive');
            that._loader();
            this.$.login_component.clean();
            console.info('allUsers', this.allUsers);
          } else {
            alert('Email o password incorrecto!!');
            that._loader();
          }
        }

        _closeSession() {
          this.$.showPosts.classList.toggle('sessionActive');
        }

        _userSelected(event) {
          console.info('userElected');
          this.selectedUser = this.allUsers.filter(item => item.email === event.detail.email)[0];
        }

        _showForm(sessionUser,selectedUser ) {
          let show = false;
          try{
            console.info('Show Form', this.sessionUser.email, this.selectedUser.email );
            show = this.sessionUser.email === this.selectedUser.email? true : false; }catch(err){}
          return show;
        }

        _loader() {
          this.$.loader_spinner[
            this.$.loader_spinner.hasAttribute('paused') ?
            'removeAttribute':'setAttribute' ]('paused', '');
        }

        _save() {
          this.shadowRoot.getElementById('title_form').value;

          this.$.postMessage.body = {
            "user": {
            	"email": this.sessionUser.email
            },
            "post": {
            	"title": this.shadowRoot.getElementById('title_form').value,
            	"body": this.shadowRoot.getElementById('posts_form').value
            }
          };
          console.info(this.$.postMessage.params);
          this.$.postMessage.generateRequest();
        }

        _handleResponse(event) {
          //this.set('users', this.$.postMessage.lastResponse.filter(item => item !== null));
          this.push('selectedUser.posts', {
            "title": this.shadowRoot.getElementById('title_form').value,
            "body": this.shadowRoot.getElementById('posts_form').value,
            "date": "2018-07-03T22:48:45.553Z"
          });

          console.info('Respuesta del formulario', event);
        }
      } // end

      //this.$.loader_spinner.setAttribute('paused', true);
      //this.$.showPosts.classList.toggle('sessionActive');

      customElements.define(AppShell.is, AppShell);

    })(window.customElements);
  </script>
</dom-module>
